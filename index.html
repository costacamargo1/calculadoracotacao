<!DOCTYPE html>
<html lang="pt-BR">
    <head>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0F2A36">
    <meta name="theme-color" content="#0F2A36">

    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Custo Online</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        
        
    :root{
    /* amostras aproximadas da imagem */
     --bg-top: #91A5A8; /* azul-cinza frio */
     --bg-mid: #9C9993; /* greige quente */
     --bg-bot: #60575F; /* cinza-ameixa suave */
}

    /* fallback sólido caso o gradiente não carregue */
    body{ background-color: var(--bg-mid); }

    body{
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
     background-image:
        radial-gradient(120% 80% at 50% -10%, rgba(0,0,0,0.08) 0%, rgba(0,0,0,0.00) 50%),
        linear-gradient(180deg, var(--bg-top) 0%, var(--bg-mid) 55%, var(--bg-bot) 100%);
        background-attachment: fixed;
        background-repeat: no-repeat;
        padding: 20px;
        min-height: 100vh;
}
        .pmvg-grid{ display:grid; grid-template-columns:1fr 1fr; gap:20px; }
        @media (max-width:768px){ .pmvg-grid{ grid-template-columns:1fr; } }

        .aviso-flag{ color:#ef4444; font-style:italic; font-weight:600; margin-top:6px; }
        .aviso-flag-positivo{ color:#10b981; font-style:italic; font-weight:600; margin-top:6px; }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .calculator {
            background: radial-gradient(1200px 600px at 50% -10%, #EEEDE9 0%, #F5F4F1 40%, #F5F4F1 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        h1 { /* Titulo Principal */
         color: #171717;
         margin-bottom: 0;             /* ✅ Remove margem inferior */
         font-size: 18px;
         font-weight: 700;
         letter-spacing: -0.02em;
         line-height: 40px;            /* ✅ Mesma altura do input (40px) */
        }
        
        h2 {
         color: #171717;
         margin-top: 40;
         margin-bottom: 24px;
         font-size: 15px;
         font-weight: 600;
         border-bottom: 2px solid #171717;
         padding-bottom: 12px;
         letter-spacing: -0.01em;
         text-align: center; /* Centralizado */
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }
        
        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #c7c7c7;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: #fff;
        }
        
        input[type="number"]:focus {
            outline: none;
            border-color: #575757;
            box-shadow: 0 0 0 3px rgba(87,87,87,0.08);
        }
        
        input[type="number"]::placeholder {
            font-size: 14px;
            color: #999;
        }        
                
        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #1a1a1a; /* Cor preta para radio */
        }
        
        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #1a1a1a; /* Cor preta para checkbox */
        }
        
        .result-box {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
            gap: 12px;
            flex-wrap: wrap;
        }

        .result-item:hover {
    background: rgba(255, 255, 255, 0.12);
    transform: translateX(4px);
}


        
        .result-item:last-child {
            margin-bottom: 0;
        }
        
        .result-label {
            font-weight: 600;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.95);
            flex: 1;
            min-width: 200px;
        }
        
.result-value {
    font-size: 19px;
    font-weight: 700;
    letter-spacing: -0.02em;
    text-align: right;
    flex-shrink: 0;
    transition: transform 0.3s ease;
}
        
        /* Mantém as cores originais */
        .result-value.positive {
            color: #10b981;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.4);
        }

        .result-value.negative {
            color: #ef4444;
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.4);
        }

        .result-value.warning {
            color: #f59e0b;
            text-shadow: 0 0 10px rgba(245, 158, 11, 0.4);
        }

        
        button {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 550;
            cursor: pointer;
            transition: transform 0.2s;
            letter-spacing: 0.5px;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, #161822, transparent);
            margin: 30px 0;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    
        /* Alinhamento Base PF + Valor ICMS 0% */
.two-col { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 20px;
}

.two-col .col { 
    display: flex;
    flex-direction: column;
}

.two-col .col label {
    display: block;
    margin-bottom: 8px;
    color: #333;
    font-weight: 600;
    font-size: 14px;
    min-height: 40px; /* Garante espaço igual para ambos os labels */
}

/* Container dos checkboxes */
.checks { 
    margin-top: 16px; 
    display: flex; 
    gap: 16px; 
    font-size: 14px; 
    align-items: center;
}

/* Cada checkbox + label */
.check { 
    display: flex !important;
    align-items: center !important;
    gap: 8px;
    margin: 0 !important;
    cursor: pointer;
    font-weight: 400;
}

/* O input (checkbox) */
.check input { 
    margin: 0;
    width: 18px;
    height: 18px;
    cursor: pointer;
    flex-shrink: 0;  /* Não encolhe */
}

@media (max-width: 768px) {
    .two-col {
        grid-template-columns: 1fr;
    }
}

/* Botões de Repasse Estilosos com Glass Effect */
.radio-group-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 10px;
    margin-top: 12px;
}

.radio-button {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px 14px;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 56px;
    }

.radio-button label {
    cursor: pointer;
    font-weight: 600;
    font-size: 13.5px;
    text-align: center;
    margin: 0 !important;
    color: #171717;
    line-height: 1.4;
    pointer-events: none;
    position: relative;
    z-index: 0;
}

.radio-button:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.radio-button input[type="radio"] {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    margin: 0;
    cursor: pointer;
    z-index: 1;
}



/* Estado Checked - Botão Selecionado */
.radio-button input[type="radio"]:checked ~ label {
    color: #ffffff;
}

.radio-button:has(input[type="radio"]:checked) {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border-color: rgba(255, 255, 255, 0.2);
    box-shadow: 
        0 4px 16px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
}

.radio-button:has(input[type="radio"]:checked):hover {
    background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
    box-shadow: 
        0 6px 20px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
}

/* Botão Disabled - MESMO VISUAL QUE OS OUTROS */
.radio-button:has(input[type="radio"]:disabled) {
    opacity: 1;
    cursor: not-allowed;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.15);
}

.radio-button:has(input[type="radio"]:disabled):hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.radio-button:has(input[type="radio"]:disabled) label {
    cursor: not-allowed;
    color: #171717;
    opacity: 1;
}

.radio-button:has(input[type="radio"]:disabled) input[type="radio"] {
    cursor: not-allowed;
}

/* Quando ISENTO está marcado (checked + disabled) */
.radio-button:has(input[type="radio"]:disabled:checked) {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border-color: rgba(255, 255, 255, 0.2);
    box-shadow: 
        0 4px 16px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
}

.radio-button:has(input[type="radio"]:disabled:checked) label {
    color: #ffffff;
}

/* Ícone/Badge de Check */
.radio-button input[type="radio"]:checked ~ label::before {
    content: "✓";
    display: inline-block;
    margin-right: 6px;
    font-weight: bold;
    animation: checkPop 0.3s ease;
}

@keyframes checkPop {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

/* Responsivo */
@media (max-width: 768px) {
    .radio-group-buttons {
        grid-template-columns: 1fr;
    }
}

/* Responsivo Mobile */
@media (max-width: 768px) {
    .result-item {
        flex-direction: column;
        align-items: flex-start;
        padding: 14px;
        gap: 8px;
    }
    
    .result-label {
        font-size: 13px;
        min-width: 100%;
        margin-bottom: 4px;
    }
    
    .result-value {
        font-size: 22px;
        text-align: left;
        width: 100%;
    }
}

/* Tablets */
@media (max-width: 1024px) and (min-width: 769px) {
    .result-label {
        font-size: 13px;
        min-width: 180px;
    }
    
    .result-value {
        font-size: 17px;
    }
}

/* Telas muito pequenas */
@media (max-width: 480px) {
    .result-item {
        padding: 12px;
    }
    
    .result-label {
        font-size: 12px;
        line-height: 1.4;
    }
    
    .result-value {
        font-size: 20px;
    }
}

</style>

    <style>
        /* Estilos que serão aplicados APENAS no PDF */
        #relatorio-pdf h1 { font-size: 20px; text-align: center; margin-bottom: 20px; color: #333; border-bottom: 2px solid #000000; padding-bottom: 10px; }
        #relatorio-pdf h2 { font-size: 16px; margin-top: 25px; margin-bottom: 10px; color: #444; border-bottom: 1px solid #000000; padding-bottom: 5px;}
        #relatorio-pdf table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        #relatorio-pdf th, #relatorio-pdf td { border: 1px solid #000000; padding: 8px; text-align: left; }
        #relatorio-pdf th { background-color: #000000; font-weight: bold; }
        #relatorio-pdf .label { font-weight: bold; width: 60%; }
        #relatorio-pdf .valor { text-align: right; }
        #relatorio-pdf .destaque-positivo { color: #28a745; font-weight: bold; }
        #relatorio-pdf .destaque-negativo { color: #dc3545; font-weight: bold; }
    </style>
<style>
    /* Resumo visível para geração do PDF */
    #resumoArea { 
    background: #FFFFFF;
    border: 1.5px solid #D4D4D4;
    border-radius: 0;
    padding: 24px;
    margin-top: 20px;
    color: #000 !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
  #resumoArea h3 {
    margin-bottom: 10px;
    text-align: center;
  }
  #resumoArea tr.espaco td {
    height: 12px;
    padding: 0;
    border: none;
    background: transparent !important;
}
#resumoArea table { width: 100%; border-collapse: collapse; }
#resumoArea td { border: 1px solid #646464; padding: 12px 16px; font-size: 14px; }
#resumoArea td.label { font-weight: 600; color: #171717; }
#resumoArea td.valor { text-align: right; color: #404040; }
#btnGerarPDFResumo { margin-top: 12px; padding: 8px 12px; }


    footer {
        text-align: center;
        padding: 30px;
        margin-top: 50px;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        border-radius: 16px;
    overflow: hidden;
    }

    footer span {
        color: #9ca3af;
        font-size: 13px;
        font-weight: 400;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        font-family: 'Inter', 'Segoe UI', sans-serif;
        
    }

    footer strong {
        color: #f5f5f5;
        font-size: 13px;
        font-weight: 600;
        margin-left: 5px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        font-family: 'Inter', 'Segoe UI', sans-serif;
        position: relative;
    }

    footer strong::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 1px;
        background: linear-gradient(90deg, transparent, #667eea, transparent);
    }


/* Botão flutuante fixo */
.btn-flutuante {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: auto;
    min-width: 80px;
    height: 50px;
    padding: 0 20px;
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    border: none;
    border-radius: 25px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
    transition: all 0.3s;
    z-index: 1000;
}

.btn-flutuante:hover {
    transform: translateY(-5px) scale(1.1);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6);
}

.btn-flutuante:active {
    transform: translateY(-2px) scale(1.05);
}

/* Tooltip no hover */
.btn-flutuante::before {
    content: 'Limpar Tudo';
    position: absolute;
    right: 70px;
    background: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
}

.btn-flutuante:hover::before {
    opacity: 1;
}
</style>
<style>
.topbar { 
    display: flex; 
    align-items: flex-end;        /* ✅ ALINHA pela BASE (linha inferior) */
    justify-content: space-between; 
    gap: 24px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    padding-bottom: 16px;         /* ✅ Espaço antes do H2 */
    border-bottom: 1px solid #E5E5E5;  /* ✅ OPCIONAL: linha separadora */
}
.produto-field { 
    display: flex; 
    align-items: center; 
    gap: 12px;                    /* ✅ Espaço entre label e input */
    min-width: 200px;             /* ✅ Largura mínima */
}
  .produto-field label{
    font-weight: 500;
    color: #171717;
    white-space: nowrap;
    margin: 0;
    line-height: 40px;            /* ✅ Mesma altura do input */
    display: flex;
    align-items: center;
    font-size: 14px;
}
  .produto-field input {
  height: 35px;
  padding: 0 10px;
  border: 1.5px solid #c7c7c7;
  border-radius: 10px;
  min-width: 260px;
  background: #fff;
  appearance: textfield;        /* ✅ Mantém aparência base sem quebrar bordas */
  -webkit-appearance: textfield; /* ✅ Safari */
}
#produtoNome::placeholder {
    font-size: 13px;
    color: #A3A3A3; /* opcional: deixar mais claro */
    font-style: italic;
    opacity: 0.7; /* opcional: deixar mais claro */
}
.produto-field input:focus {
    outline: none;
    border-color: #171717;
    box-shadow: 0 0 0 3px rgba(23,23,23,0.08);
}



</style>
</head>
<body>
    <div class="container">
        <!-- CALCULADORA 1: CÁLCULO DO CUSTO -->
        <div class="calculator">
        <div class="topbar"><h1>• Calculadora de Custo e Margens - MEDICAMENTOS</h1><div class="produto-field"><label for="produtoNome">PRODUTO:</label><input type="text" id="produtoNome" placeholder="Ex.: Mesalazina 1g Supositório"></div></div>
            <h2>CÁLCULO DE CUSTO DO PRODUTO</h2>
            
<div class="form-group two-col">
    <div class="col">
        <label>BASE DE CÁLCULO PF (R$):<br><em>• Para base, considerar ICMS 17% - ES</em></label>
        <input type="number" id="basePF" step="0.0001" placeholder="Inserir PF 17%">
        
        <!-- ✅ ESTRUTURA CORRETA -->
        <div class="checks">
            <label class="check">
                <input type="checkbox" id="chkDesonerado"> 
                DESONERADO (87/02)
            </label>
            
            <label class="check">
                <input type="checkbox" id="chkIsento"> 
                ISENTO (162/94 OU 140/01)
            </label>
        </div>
    </div>
    
    <div class="col">
        <label>VALOR ICMS 0% (R$):</label>
        <input type="number" id="valorICMS0" step="0.0001" placeholder="Valor da base com ICMS 0%">
    </div>
</div>

           <div class="form-group">
                <label>CAP 21,53%:</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="capSim" name="cap" value="sim" onchange="calcularPMVG()">
                        <label for="capSim" style="margin: 0;">SIM</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="capNao" name="cap" value="nao" checked onchange="limparPMVG()">
                        <label for="capNao" style="margin: 0;">NÃO</label>
                    </div>
                </div>
            </div>

            <div class="form-group" id="campoPMVG" style="display:none;">
                <div class="pmvg-grid">
                <div class="col">
                <label>VALOR DE VENDA - PMVG (CAP -21,53%) - R$:</label>
                <input type="number" id="valorPMVG" step="0.0001" placeholder="Calculado automaticamente ou inserido manualmente">
            </div>

             <!-- NOVO CAMPO -->
             <div class="col" id="campoPMVG0" style="display:none;">
                <label>VALOR PMVG 0% — (ISENTO ou DESONERADO) - R$:</label>
                <input type="number" id="valorPMVG0" step="0.0001" placeholder="Preenchido quando ISENTO/DESONERADO">
                </div>
            </div>
         </div>

            
            <div class="form-group">
                <label>DESCONTO (%):</label>
                <input type="number" id="desconto" step="0.01" placeholder="Inserir desconto comercial recebido na cotação">
            </div>
 
            
            <div class="form-group">
               <label>REPASSE:<br> <em>• Produto nacional: 10,75% - Produto Importado: 13,54%</em></label>
            <div class="radio-group-buttons">
                <div class="radio-button">
                    <input type="radio" id="repasse1075" name="repasse" value="10.75" checked>
                    <label for="repasse1075">10,75%<br><small style="font-size:11px;">Nacional</small></label>
                </div>
            <div class="radio-button">
                    <input type="radio" id="repasse1354" name="repasse" value="13.54">
                    <label for="repasse1354">13,54%<br><small style="font-size:11px; opacity:0.8;">Importado</small></label>
                </div>
                    <div class="radio-button">
            <input type="radio" id="repasseNaoSei" name="repasse" value="0">
            <label for="repasseNaoSei">SEM<br>INFORMAÇÃO</label>
        </div>
        <div class="radio-button" title="Marcado automaticamente quando [X] ISENTO">
            <input type="radio" id="repasseIsento" name="repasse" value="0" disabled>
            <label for="repasseIsento">SEM REPASSE<br><small style="font-size:11px; opacity:0.8;">Isento</small></label>
        </div>
    </div>
    <div style="text-align: center;">
<button onclick="calcularCusto()" style="margin: 30px 0 -30px 0;">CALCULAR CUSTO</button>
                </div>
            </div>
        </div>
            
            
            
            <div class="result-box" id="resultadoCusto" style="display: none;">
<div class="result-item">
                    <span class="result-label">VALOR DE CUSTO R$:</span>
                    <span class="result-value" id="valorCusto">R$ 0,0000</span>
                </div>
                <div class="result-item">
                    <span class="result-label">MARGEM → CUSTO X BASE PF:</span>
                    <span class="result-value" id="margemBaseCusto">0,00%</span>
                </div>
                <div class="result-item" id="itemPMVGCusto" style="display: none;">
                    <span class="result-label">MARGEM → CUSTO X PMVG:</span>
                    <span class="result-value" id="margemPMVGCusto">0,00%</span>
                </div>

                
            </div>
            <div style="text-align: left; margin-top: 20px;">
            
        
        <div class="divider"></div>
        
        <!-- CALCULADORA 2: MARGENS E DEFASAGENS -->
        <div class="calculator">
            <h2>CÁLCULO DE MARGENS E DEFASAGENS</h2>
            
            <div class="form-group">
                <label>VALOR DE CUSTO (R$):</label>
                <input type="number" id="custoProduto" step="0.0001" placeholder="Valor de custo será importado automaticamente. Poderá ser inserido de forma manual.">
            </div>
            
            <div class="form-group">
             <label>VALOR DO PF OU PMVG (R$):</label>
            <input type="number" id="valorPF" step="0.0001" placeholder="Valor será importado automaticamente. Poderá ser inserido de forma manual.">
             <!-- AVISO quando usar PMVG 0% -->
            <div id="avisoPF" class="aviso-flag" style="display:none;">
             PRODUTO MARCADO COMO: ISENTO/DESONERADO — <em>ATENÇÃO NO CÁLCULO</em>
            </div>
            </div>
            
<div class="form-group">
    <div class="pmvg-grid">
        <div class="col">
            <label>VALOR DE VENDA (R$):</label>
            <input type="number" id="valorVenda" step="0.0001" placeholder="Inserir valor de venda">
            <div class="checkbox-option">
                <input type="checkbox" id="repetirPF" onchange="repetirValorPF()">
                <label for="repetirPF" style="margin: 0;">REPETIR PF</label>
            </div>
        </div>
        <div class="col">
    <label>MARGEM DIRETA (%):</label>
    <input type="number" id="margemDireta" step="0.01" placeholder="Ex: 25 para 25% de margem" oninput="calcularVendaPorMargem()">
    <div style="font-size: 12px; color: #666; margin-top: 4px;">
        <em>• Calcula automaticamente o valor de venda</em>
    </div>
    <div id="sugestaoMargem" style="font-size: 12px; color: #ef4444; font-weight: 600; margin-top: 4px; display: none;">
    </div>
</div>
</div>
            
            <div class="form-group">
                <label>VALOR ESTIMADO (R$):</label>
                <input type="number" id="valorEstimado" step="0.0001" placeholder="Se houver, inserir valor estimado.">
            </div>
            <div style="text-align: center;">
            <button onclick="calcularMargens()">CALCULAR MARGENS</button>
            </div>
<div class="result-box" id="resultadoMargens" style="display: none;">
<div class="result-item">
                    <span class="result-label">MARGEM → CUSTO X VALOR DE VENDA:</span>
                    <span class="result-value" id="margemVendaCusto">0,00%</span>
                </div>
                <div class="result-item">
                    <span class="result-label">MARGEM → CUSTO X VALOR ESTIMADO:</span>
                    <span class="result-value" id="margemEstimadoCusto">0,00%</span>
                </div>
                <div class="result-item">
                    <span class="result-label">MARGEM → CUSTO X VALOR DO PF OU PMVG:</span>
                    <span class="result-value" id="margemPFPmvgCusto">0,00%</span>
                </div>
                <div class="result-item">
                    <span class="result-label">DIFERENÇA PERCENTUAL → VALOR DE VENDA X ESTIMADO:</span>
                    <span class="result-value" id="margemVendaEstimado">0,00%</span>
                </div>
                <div id="avisoMargemEstimado" class="aviso-flag" style="display:none; color:#10b981;">
                </div>
<div id="resumoArea" style="display:none;">
  <h3>RELATÓRIO DE CUSTO DO PRODUTO</h3>
  <table>
    <tr><td class="label">PRODUTO</td><td class="valor" id="r_produto"></td></tr>
    <tr class="espaco"><td colspan="2"></td></tr>
    <tr><td class="label">BASE DE CÁLCULO PF (R$)</td><td class="valor" id="r_pf"></td></tr>
    <tr><td class="label">DESCONTO (%)</td><td class="valor" id="r_desc"></td></tr>
    <tr><td class="label">REPASSE (%)</td><td class="valor" id="r_repasse"></td></tr>
    <tr><td class="label">CAP 21,53%</td><td class="valor" id="r_cap"></td></tr>
    <tr><td class="label">DESONERADO</td><td class="valor" id="r_desonerado"></td></tr>
    <tr><td class="label">ISENTO</td><td class="valor" id="r_isento"></td></tr>
    <tr class="espaco"><td colspan="2"></td></tr>
    <tr><td class="label">VALOR DE CUSTO (R$)</td><td class="valor" id="r_custo"></td></tr>
    <tr class="espaco"><td colspan="2"></td></tr>
    <tr><td class="label">VALOR DE VENDA (R$)</td><td class="valor" id="r_valorvenda"></td></tr>
    <tr><td class="label">VALOR PMVG (R$)</td><td class="valor" id="r_pmvg"></td></tr>
    <tr><td class="label">VALOR ESTIMADO (R$)</td><td class="valor" id="r_estimado"></td></tr>
    <tr class="espaco"><td colspan="2"></td></tr>
    <tr><td class="label">MARGEM → CUSTO X VALOR DE VENDA</td><td class="valor" id="r_m_vc"></td></tr>
    <tr><td class="label">MARGEM → CUSTO X VALOR ESTIMADO</td><td class="valor" id="r_m_ec"></td></tr>
    <tr><td class="label">MARGEM → CUSTO X VALOR DO PF OU PMVG</td><td class="valor" id="r_m_pfpmvg"></td></tr>
    <tr><td class="label">DIFERENÇA % → VALOR DE VENDA X ESTIMADO</td><td class="valor" id="r_m_ve"></td></tr>


  </table>
  <div style="text-align:center;">
    <button id="btnGerarPDFResumo">📄 GERAR RELATÓRIO</button>
  </div>
</div>

            

                
</div>


    <button id="btnGerarPDF">📄 Gerar PDF para Impressão</button>
</div>
        </div>
    </div>
 <div id="relatorio-pdf" style="display: none; font-family: Arial, sans-serif; color: #000;">

    <h1>Relatório de Análise de Custos e Margens</h1>

    <h2>1. Dados de Entrada para Custo</h2>
    <table>
        <tr><td class="label">Produto</td><td class="valor" id="pdfProdutoNome"></td></tr>
<tr>
            <td class="label">Base de Cálculo PF (R$)</td>
            <td class="valor" id="pdfBasePF"></td>
        </tr>
        <tr>
            <td class="label">Desconto Aplicado (%)</td>
            <td class="valor" id="pdfDesconto"></td>
        </tr>
        <tr>
            <td class="label">Aplica CAP (21,53%)?</td>
            <td class="valor" id="pdfAplicaCAP"></td>
        </tr>
        <tr>
            <td class="label">Valor de Venda PMVG (R$)</td>
            <td class="valor" id="pdfValorPMVG"></td>
        </tr>
        <tr>
            <td class="label">Repasse (%)</td>
            <td class="valor" id="pdfRepasse"></td>
        </tr>
    </table>

    <h2>2. Resultados do Custo do Produto</h2>
    <table>
        <tr>
            <td class="label">VALOR DE CUSTO FINAL (R$)</td>
            <td class="valor"><b id="pdfCustoFinal"></b></td>
        </tr>
        <tr>
            <td class="label">MARGEM (Custo x Base PF)</td>
            <td class="valor" id="pdfMargemBaseCusto"></td>
        </tr>
        <tr>
            <td class="label">MARGEM (Custo x PMVG)</td>
            <td class="valor" id="pdfMargemPMVGCusto"></td>
        </tr>
    </table>

    <h2>3. Análise de Margens e Defasagens</h2>
    <table>
         <tr>
            <td class="label">Valor de Venda Praticado (R$)</td>
            <td class="valor" id="pdfValorVenda"></td>
        </tr>
         <tr>
            <td class="label">Valor Estimado / Concorrência (R$)</td>
            <td class="valor" id="pdfValorEstimado"></td>
        </tr>
        <tr>
            <td class="label">MARGEM (Custo x Venda)</td>
            <td class="valor" id="pdfMargemVendaCusto"></td>
        </tr>
        <tr>
            <td class="label">MARGEM (Custo x Estimado)</td>
            <td class="valor" id="pdfMargemEstimadoCusto"></td>
        </tr>
        <tr>
            <td class="label">DIFERENÇA (Venda x Estimado)</td>
            <td class="valor" id="pdfMargemVendaEstimado"></td>
        </tr>
    </table>
</div>

    <script>

// Função para gerar o PDF formatado como um relatório
function gerarPDF() {
    // --- VERIFICA SE OS RESULTADOS ESTÃO VISÍVEIS ---
    const resultadoCustoVisivel = document.getElementById('resultadoCusto').style.display !== 'none';
    const resultadoMargensVisivel = document.getElementById('resultadoMargens').style.display !== 'none';

    // --- COLETA DE DADOS DE ENTRADA (SEMPRE SEGURO) ---
    const basePF = document.getElementById('basePF').value || "0.0000";
    const desconto = (document.getElementById('desconto').value || "0") + "%";
    const aplicaCAP = document.getElementById('capSim').checked ? "SIM" : "NÃO";
    const valorPMVG = document.getElementById('valorPMVG').value || "N/A";
    const repasseElement = document.querySelector('input[name="repasse"]:checked');
    const repasse = repasseElement ? repasseElement.value + "%" : "N/A";
    const valorVenda = document.getElementById('valorVenda').value || "0.0000";
    const valorEstimado = document.getElementById('valorEstimado').value || "0.0000";

    // --- COLETA DE RESULTADOS (APENAS SE ESTIVEREM VISÍVEIS) ---
    const custoFinal = resultadoCustoVisivel ? document.getElementById('valorCusto').textContent : "N/A";
    const margemBaseCusto = resultadoCustoVisivel ? document.getElementById('margemBaseCusto').textContent : "N/A";
    const margemPMVGCusto = document.getElementById('itemPMVGCusto').style.display === 'flex' ? document.getElementById('margemPMVGCusto').textContent : "N/A";
    
    const margemVendaCusto = resultadoMargensVisivel ? document.getElementById('margemVendaCusto').textContent : "N/A";
    const margemEstimadoCusto = resultadoMargensVisivel ? document.getElementById('margemEstimadoCusto').textContent : "N/A";
    const margemVendaEstimado = resultadoMargensVisivel ? document.getElementById('margemVendaEstimado').textContent : "N/A";

    // --- PREENCHIMENTO DA ESTRUTURA INVISÍVEL ---
    const prodNomeVal = (document.getElementById('produtoNome') ? document.getElementById('produtoNome').value : '');
    if (document.getElementById('pdfProdutoNome')) document.getElementById('pdfProdutoNome').innerText = prodNomeVal;
    document.getElementById('pdfBasePF').innerText = basePF;
    document.getElementById('pdfDesconto').innerText = desconto;
    document.getElementById('pdfAplicaCAP').innerText = aplicaCAP;
    document.getElementById('pdfValorPMVG').innerText = valorPMVG;
    if (document.getElementById('pdfValorEstimado')) document.getElementById('pdfValorEstimado').innerText = valorEstimado;
    document.getElementById('pdfRepasse').innerText = repasse;
    document.getElementById('pdfCustoFinal').innerText = custoFinal;
    document.getElementById('pdfMargemBaseCusto').innerText = margemBaseCusto;
    document.getElementById('pdfMargemPMVGCusto').innerText = margemPMVGCusto;
    document.getElementById('pdfValorVenda').innerText = valorVenda;
    document.getElementById('pdfValorEstimado').innerText = valorEstimado;
    document.getElementById('pdfMargemVendaCusto').innerText = margemVendaCusto;
    document.getElementById('pdfMargemEstimadoCusto').innerText = margemEstimadoCusto;
    document.getElementById('pdfMargemVendaEstimado').innerText = margemVendaEstimado;
    
    // --- GERAÇÃO DO PDF ---
    const elementoParaPDF = document.getElementById("relatorio-pdf");

// Salva o estilo anterior para restaurar depois
const estiloAnterior = elementoParaPDF.getAttribute('style') || '';

// Tira de display:none e posiciona fora da tela para garantir layout/reflow
elementoParaPDF.setAttribute(
  'style',
  (estiloAnterior ? estiloAnterior + '; ' : '') +
  'display:block !important; position:fixed; left:-10000px; top:0; ' +
  'background:#ffffff; width:auto; max-width:100%;'
);

// Aguarda um frame para o layout "assentar" antes da captura
requestAnimationFrame(() => {
  const opcoes = {
    margin: [0.5, 0.5, 0.5, 0.5],
    filename: 'Relatorio_Custos_e_Margens.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, scrollX: 0, scrollY: 0, backgroundColor: '#ffffff' },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
  };

  html2pdf().set(opcoes).from(elementoParaPDF).save()
    .then(() => {
      elementoParaPDF.setAttribute('style', estiloAnterior);
    })
    .catch((err) => {
      elementoParaPDF.setAttribute('style', estiloAnterior);
      console.error(err);
      alert('Falha ao gerar PDF: ' + (err && err.message ? err.message : err));
    });
});
}

// Adiciona o "escutador de evento" ao botão que criamos
document.getElementById('btnGerarPDF').addEventListener('click', gerarPDF);

function atualizarAvisoPF(ativo, tipo){
  const aviso = document.getElementById('avisoPF');
  if(!aviso) return;
  if(ativo){
    aviso.style.display = 'block';
    aviso.innerHTML = `PRODUTO MARCADO COMO: <strong>${tipo}</strong> — <em>ATENÇÃO NO CÁLCULO</em>`;
  } else {
    aviso.style.display = 'none';
    aviso.textContent = '';
  }
}
        
function calcularPMVG() {
  const basePF = parseFloat(document.getElementById('basePF')?.value || '');
  const des = document.getElementById('chkDesonerado')?.checked || false;
  const isento = document.getElementById('chkIsento')?.checked || false;
  const capAtivo = document.getElementById('capSim')?.checked || false;

  const boxPMVG = document.getElementById('campoPMVG');
  const boxPMVG0 = document.getElementById('campoPMVG0');
  const icms0El = document.getElementById('valorICMS0');

  if (!capAtivo) {
    if (boxPMVG) boxPMVG.style.display = 'none';
    const pmvgEl = document.getElementById('valorPMVG');
    const pmvg0El = document.getElementById('valorPMVG0');
    if (pmvgEl) pmvgEl.value = '';
    if (pmvg0El) pmvg0El.value = '';
    atualizarAvisoPF(false);
    return;
  }

  if (isNaN(basePF) || basePF <= 0) return;

  if (boxPMVG) boxPMVG.style.display = 'block';

  // 1) PMVG (21,53%) SEMPRE sobre a BASE PF
  const pmvgBase = Math.trunc((basePF * (1 - 21.53/100)) * 10000) / 10000;
  document.getElementById('valorPMVG').value = pmvgBase.toFixed(4);

  // 2) Quando ISENTO/DESONERADO, calcula ICMS 0% e o PMVG 0% (com CAP)
  if (des || isento) {
    const valorICMS0 = +(basePF * 0.83).toFixed(4);
    if (icms0El) icms0El.value = valorICMS0.toFixed(4);

    const pmvg0 = valorICMS0 * (1 - 21.53/100);
    if (boxPMVG0) boxPMVG0.style.display = 'block';
    const pmvg0El = document.getElementById('valorPMVG0');
    if (pmvg0El) pmvg0El.value = pmvg0.toFixed(4);

    // → Calculadora 2 passa a usar o PMVG 0%
    document.getElementById('valorPF').value = pmvg0.toFixed(4);
    atualizarAvisoPF(true, isento ? 'ISENTO' : 'DESONERADO');

  } else {
    // Sem isento/desonerado: zera ICMS0 e esconde PMVG 0%
    if (icms0El) icms0El.value = '';
    if (boxPMVG0) boxPMVG0.style.display = 'none';
    const pmvg0El = document.getElementById('valorPMVG0');
    if (pmvg0El) pmvg0El.value = '';

    // → Calculadora 2 usa o PMVG sobre a base
    document.getElementById('valorPF').value = pmvgBase.toFixed(4);
    atualizarAvisoPF(false);
  }
}

        
        function limparPMVG() {
            document.getElementById('campoPMVG').style.display = 'none';
            document.getElementById('valorPMVG').value = '';
            document.getElementById('itemPMVGCusto').style.display = 'none';
        }
        
        // Recalcular PMVG quando base PF ou desconto mudarem
document.getElementById('basePF').addEventListener('input', function () {
  const raw = this.value;
  const v = parseFloat(raw);

  if (!raw || isNaN(v) || v <= 0) {
    zerarCalculosPorBase();
    return;
  }

  // Se CAP = SIM, recalcula normalmente
  if (document.getElementById('capSim').checked) {
    calcularPMVG();
  }
  
  // ← NOVO: Recalcula ICMS 0% se ISENTO/DESONERADO estiver marcado
  calcularICMS0SemCAP();
});

        // Mantém PF/PMVG sincronizados ao editar o PMVG manualmente, quando CAP = SIM
        document.getElementById('valorPMVG').addEventListener('input', function(){
            if (document.getElementById('capSim').checked) {
                document.getElementById('valorPF').value = this.value;
            }
        });

        // Recalcular PMVG quando o desconto mudar (sincroniza PF também)
        document.getElementById('desconto').addEventListener('input', function(){
            if (document.getElementById('capSim').checked) {
                calcularPMVG();
            }
        });

        // Mantém o valor de venda igual ao PF quando 'Repetir PF' estiver marcado
        document.getElementById('valorPF').addEventListener('input', function(){
            if (document.getElementById('repetirPF').checked) {
                document.getElementById('valorVenda').value = this.value;
            }
        });

        
        
 function calcularCusto() {
    const basePF = parseFloat(document.getElementById('basePF').value);
    const desconto = parseFloat(document.getElementById('desconto').value);
    const capSim = document.getElementById('capSim').checked;
    const selecionadoRep = document.querySelector('input[name="repasse"]:checked');
    const repasseSelecionado = selecionadoRep ? selecionadoRep.value : '0';
    let repasse = parseFloat(repasseSelecionado);
    
    const isento = document.getElementById('chkIsento') && document.getElementById('chkIsento').checked;
    const desonerado = document.getElementById('chkDesonerado') && document.getElementById('chkDesonerado').checked;
    const valorICMS0 = parseFloat(document.getElementById('valorICMS0').value);
    
    if (isento) { repasse = 0; }
    
    // VALIDAÇÃO AJUSTADA: Permite cálculo se tiver BASE PF OU VALOR ICMS 0%
    const temBasePF = !isNaN(basePF);
    const temICMS0 = !isNaN(valorICMS0) && valorICMS0 > 0;
    
    if ((!temBasePF && !temICMS0) || isNaN(desconto)) {
        alert('Por favor, preencha a Base de Cálculo PF (ou VALOR ICMS 0%) e o Desconto.');
        return;
    }
    
    // LÓGICA AJUSTADA: Define qual será a base para o cálculo
// Para VALOR DE CUSTO: a base é SEMPRE a BASE PF
if (!temBasePF) {
  alert('Por favor, preencha a Base de Cálculo PF.');
  return;
}
let baseCalculo = basePF;

    
    let valorAtual = baseCalculo;
    
    // Aplicar desconto
    valorAtual = valorAtual * (1 - desconto / 100);
    
    // Aplicar CAP se selecionado
    if (capSim) {
        valorAtual = valorAtual * (1 - 21.53 / 100);
    }
    
    // Aplicar Repasse se não for "NÃO SEI"
    if (repasse > 0) {
        valorAtual = valorAtual * (1 - repasse / 100);
    }
    
    const valorCusto = valorAtual;
    // FÓRMULA CORRIGIDA: Margem sobre o custo, usando a BASE correta
    const margemPercent = ((baseCalculo - valorCusto) / valorCusto) * 100;
    
    // Exibir resultados
    document.getElementById('valorCusto').textContent = `R$ ${valorCusto.toFixed(4)}`;
    
    const elementoMargem = document.getElementById('margemBaseCusto');
    elementoMargem.textContent = `${margemPercent.toFixed(2)}%`;
    
    // Aplicar cor baseado na margem
    if (margemPercent < 0) {
        elementoMargem.className = 'result-value negative';
    } else if (margemPercent < 25) {
        elementoMargem.className = 'result-value warning';
    } else {
        elementoMargem.className = 'result-value positive';
    }
    
    // Calcular PMVG x Custo se PMVG existir
    const valorPMVG = parseFloat(document.getElementById('valorPMVG').value);
    if (!isNaN(valorPMVG) && valorPMVG > 0) {
        const margemPMVGReal = valorPMVG - valorCusto;
        const margemPMVGPercent = (margemPMVGReal / valorCusto) * 100;
        
        const elementoPMVG = document.getElementById('margemPMVGCusto');
        elementoPMVG.textContent = `${margemPMVGPercent.toFixed(2)}%`;
        
        // Aplicar cor baseado na margem
        if (margemPMVGPercent < 0) {
            elementoPMVG.className = 'result-value negative';
        } else if (margemPMVGPercent < 25) {
            elementoPMVG.className = 'result-value warning';
        } else {
            elementoPMVG.className = 'result-value positive';
        }
        
        document.getElementById('itemPMVGCusto').style.display = 'flex';
    } else {
        document.getElementById('itemPMVGCusto').style.display = 'none';
    }
    
    document.getElementById('resultadoCusto').style.display = 'block';
    
    // Auto-preencher na calculadora 2
    document.getElementById('custoProduto').value = valorCusto.toFixed(4);
}
// Listener para recalcular valor de venda quando o custo mudar
document.getElementById('custoProduto').addEventListener('input', function() {
    const margemDireta = document.getElementById('margemDireta').value;
    // Se houver margem direta preenchida, recalcula automaticamente
    if (margemDireta !== '') {
        calcularVendaPorMargem();
    }
});
function limparTudo() {
    // Confirma antes de limpar
    if (!confirm('Deseja realmente limpar todos os campos?')) {
        return;
    }
        // Limpa com verificação
    const campos = ['produtoNome', 'basePF', 'valorICMS0', 'desconto', 'valorPMVG', 
                    'custoProduto', 'valorPF', 'valorVenda', 'valorEstimado', 'margemDireta'];
    
    campos.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    
    // Limpa campos de texto e número
    document.getElementById('produtoNome').value = '';
    document.getElementById('basePF').value = '';
    document.getElementById('valorICMS0').value = '';
    document.getElementById('desconto').value = '';
    document.getElementById('valorPMVG').value = '';
    document.getElementById('custoProduto').value = '';
    document.getElementById('valorPF').value = '';
    document.getElementById('valorVenda').value = '';
    document.getElementById('valorEstimado').value = '';
    document.getElementById('margemDireta').value = '';
    
    // Desmarca checkboxes
    document.getElementById('chkDesonerado').checked = false;
    document.getElementById('chkIsento').checked = false;
    document.getElementById('repetirPF').checked = false;
    
    // Reseta radio buttons para valores padrão
    document.getElementById('capNao').checked = true;
    document.getElementById('repasse1075').checked = true;
    
    // Reabilita opções de repasse
    document.getElementById('repasse1075').disabled = false;
    document.getElementById('repasse1354').disabled = false;
    document.getElementById('repasseNaoSei').disabled = false;
    
    // Esconde resultados
    document.getElementById('resultadoCusto').style.display = 'none';
    document.getElementById('resultadoMargens').style.display = 'none';
    document.getElementById('resumoArea').style.display = 'none';
    document.getElementById('campoPMVG').style.display = 'none';

    // BASE PF
     zerarCalculosPorBase();
    
    // Foca no primeiro campo
    document.getElementById('produtoNome').focus();
}


function calcularMargens() {
    const custo = parseFloat(document.getElementById('custoProduto').value);
    const venda = parseFloat(document.getElementById('valorVenda').value);
    const pfpmvg = parseFloat(document.getElementById('valorPF').value);
    const estimado = parseFloat(document.getElementById('valorEstimado').value);
    
    // Elementos do resultado
    const resultadoMargens = document.getElementById('resultadoMargens');
    const elementoVC = document.getElementById('margemVendaCusto');
    const elementoEC = document.getElementById('margemEstimadoCusto');
    const elementoVE = document.getElementById('margemVendaEstimado');
    const elementoPF = document.getElementById('margemPFPmvgCusto');

    // Função interna para aplicar estilo e texto
    const atualizarMargem = (elemento, valor) => {
        // Se o valor não for um número (NaN, Infinity), exibe 'N/A'
        if (isNaN(valor) || !isFinite(valor)) {
            elemento.textContent = 'N/A';
            elemento.className = 'result-value'; // Estilo padrão
            return;
        }

        elemento.textContent = `${valor.toFixed(2)}%`;
        if (valor < 0) {
            elemento.className = 'result-value negative';
        } else if (valor < 25) {
            elemento.className = 'result-value warning';
        } else {
            elemento.className = 'result-value positive';
        }
    };
    // Verifica se conseguimos atender o estimado com margem >= 25%
const avisoMargemEstimado = document.getElementById('avisoMargemEstimado');
if (avisoMargemEstimado) {
    if (!isNaN(custo) && custo > 0 && !isNaN(estimado) && estimado > 0) {
        const margemCustoEstimado = ((estimado - custo) / custo) * 100;
        
        if (margemCustoEstimado >= 25) {
            avisoMargemEstimado.innerHTML = `✅ <strong>CONSEGUIMOS ATENDER O VALOR ESTIMADO</strong> com <strong>${margemCustoEstimado.toFixed(2)}%</strong> de margem.`;
            avisoMargemEstimado.style.display = 'block';
            avisoMargemEstimado.style.color = '#10b981';
        } else {
            avisoMargemEstimado.style.display = 'none';
        }
    } else {
        avisoMargemEstimado.style.display = 'none';
    }
}

    // VERIFICAÇÃO PRINCIPAL: O custo deve ser um número válido e maior que zero.
    if (isNaN(custo) || custo <= 0) {
        // Se o custo for inválido, não podemos calcular as margens.
        atualizarMargem(elementoVC, NaN);
        atualizarMargem(elementoEC, NaN);
    } else {
        // Se o custo for válido, calcula as margens.
        const margemVCPercent = ((venda - custo) / custo) * 100;
        atualizarMargem(elementoVC, margemVCPercent);

        const margemECPercent = ((estimado - custo) / custo) * 100;
        atualizarMargem(elementoEC, margemECPercent);
    
        // Margem → Custo x Valor do PF ou PMVG
        const margemPFPmvgPercent = ((pfpmvg - custo) / custo) * 100;
        atualizarMargem(elementoPF, margemPFPmvgPercent);
}

    // A diferença Venda x Estimado não depende do custo, pode ser calculada separadamente
    if (isNaN(estimado) || estimado === 0 || isNaN(venda) || venda === 0) {
    elementoVE.textContent = 'N/A';
    elementoVE.className = 'result-value';
    } else {
    const margemVEPercent = ((venda - estimado) / estimado) * 100;
    let mensagem = '';
    let classeCSS = 'result-value';
    
    const diferencaPercentual = Math.abs(margemVEPercent);
    
    if (diferencaPercentual < 0.1) {
        // Diferença menor que 0.0% = praticamente igual
        mensagem = ` (VALOR ESTIMADO OK)`;
        classeCSS = 'result-value positive';
    } else if (venda > estimado) {
        // Venda maior que estimado = DEFASADO
        if (diferencaPercentual <= 1) {
            // Diferença pequena (até 1%)
            mensagem = ` (LEVEMENTE DEFASADO)`;
            classeCSS = 'result-value warning';
        } else {
            // Diferença significativa (acima de 1%)
            mensagem = ` (DEFASADO)`;
            classeCSS = 'result-value negative';
        }
    } else {
        // Venda menor que estimado = ABAIXO DO ESTIMADO (preço competitivo)
        mensagem = ` (ABAIXO DO ESTIMADO)`;
        classeCSS = 'result-value positive';
    }
    
    elementoVE.textContent = `${margemVEPercent.toFixed(2)}%${mensagem}`;
    elementoVE.className = classeCSS;
}
    
    // Garante que a caixa de resultados SEMPRE apareça
    
// === Preenche o RESUMO para PDF ===
    try {
    const basePF = document.getElementById('basePF') ? (document.getElementById('basePF').value || "0.0000") : "N/A";
    const desconto = document.getElementById('desconto') ? ((document.getElementById('desconto').value || "0") + "%") : "N/A";
    const cap = document.getElementById('capSim') ? (document.getElementById('capSim').checked ? "SIM" : "NÃO") : "N/A";
    const valorPMVG = document.getElementById('valorPMVG') ? (document.getElementById('valorPMVG').value || "N/A") : "N/A";
    const repSel = document.querySelector('input[name="repasse"]:checked');
    const repasse = repSel ? (repSel.value + "%") : "N/A";
    const custoFinal = document.getElementById('valorCusto') ? (document.getElementById('valorCusto').textContent || "N/A") : "N/A";
    const desonerado = document.getElementById('chkDesonerado')?.checked ? "SIM" : "NÃO";
    const isento = document.getElementById('chkIsento')?.checked ? "SIM" : "NÃO";
    const valorVenda = document.getElementById('valorVenda')?.value || "N/A";

        // Usa os valores recém-calculados das margens
    const vVC = document.getElementById('margemVendaCusto') ? document.getElementById('margemVendaCusto').textContent : "N/A";
    const vEC = document.getElementById('margemEstimadoCusto') ? document.getElementById('margemEstimadoCusto').textContent : "N/A";
    const vVE = document.getElementById('margemVendaEstimado') ? document.getElementById('margemVendaEstimado').textContent : "N/A";

        // Preenche o resumo
    const setTxt = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
    setTxt('r_produto', (document.getElementById('produtoNome') ? (document.getElementById('produtoNome').value || '—') : '—'));
    setTxt('r_pf', basePF);
    setTxt('r_desc', desconto);
    setTxt('r_cap', cap);
    setTxt('r_pmvg', valorPMVG);
    setTxt('r_repasse', repasse);
    setTxt('r_custo', custoFinal);
    setTxt('r_desonerado', desonerado);
    setTxt('r_isento', isento);
    setTxt('r_valorvenda', valorVenda);
    
    setTxt('r_m_vc', vVC);
    setTxt('r_m_ec', vEC);
    setTxt('r_m_pfpmvg', (document.getElementById('margemPFPmvgCusto') ? document.getElementById('margemPFPmvgCusto').textContent : 'N/A'));
    setTxt('r_m_ve', vVE);

        // Exibe o resumo
        const resumo = document.getElementById('resumoArea');
        if (resumo) resumo.style.display = 'block';
    } catch(e) {
        console.warn('Não foi possível preencher o resumo:', e);
    }
const elVE = document.getElementById('r_estimado');if (elVE) { const v = (document.getElementById('valorEstimado') ? document.getElementById('valorEstimado').value : ''); elVE.textContent = v; }resultadoMargens.style.display = 'block';
}
        
        // Adicionar listeners para cálculo em tempo real
        document.getElementById('valorPF').addEventListener('input', function() {
            if (document.getElementById('repetirPF').checked) {
                repetirValorPF();
            }
        });
    </script>
    
<script>
function repetirValorPF() {
    const checkbox = document.getElementById('repetirPF');
    const valorPF = document.getElementById('valorPF').value;
    if (checkbox && checkbox.checked && valorPF) {
        document.getElementById('valorVenda').value = valorPF;
        // Limpa margem direta quando repetir PF
        document.getElementById('margemDireta').value = '';
    }
}

// Calcula o valor de venda baseado na margem direta informada
// Calcula o valor de venda baseado na margem direta informada
function calcularVendaPorMargem() {
    const custo = parseFloat(document.getElementById('custoProduto').value);
    const margemDireta = parseFloat(document.getElementById('margemDireta').value);
    const sugestaoDiv = document.getElementById('sugestaoMargem');
    
    // Se apagar a margem, limpa o valor de venda e sugestão
    if (document.getElementById('margemDireta').value === '' || isNaN(margemDireta)) {
        document.getElementById('valorVenda').value = '';
        if (sugestaoDiv) sugestaoDiv.style.display = 'none';
        return;
    }
    
    // Se não tiver custo válido, não faz nada
    if (isNaN(custo) || custo <= 0) {
        if (sugestaoDiv) sugestaoDiv.style.display = 'none';
        return;
    }
    
    // Fórmula: Valor de Venda = Custo × (1 + Margem/100)
    const valorVenda = custo * (1 + margemDireta / 100);
    
    // Atualiza o campo de valor de venda
    document.getElementById('valorVenda').value = valorVenda.toFixed(4);
    
    // Desmarca "Repetir PF" se estiver marcado
    document.getElementById('repetirPF').checked = false;
    
    // Verifica se tem mais de 2 casas decimais
    const valorVendaArredondado = Math.round(valorVenda * 100) / 100;
    const temMaisDe2Casas = Math.abs(valorVenda - valorVendaArredondado) > 0.0001;
    
    if (temMaisDe2Casas && sugestaoDiv) {
        // Calcula valores com exatamente 2 casas decimais (arredondado para baixo e para cima)
        const vendaBaixo = Math.floor(valorVenda * 100) / 100;
        const vendaCima = Math.ceil(valorVenda * 100) / 100;
        
        // Calcula a MARGEM EXATA que resulta nesses valores
        // Fórmula reversa: Margem = ((Venda / Custo) - 1) × 100
        const margemBaixo = ((vendaBaixo / custo) - 1) * 100;
        const margemCima = ((vendaCima / custo) - 1) * 100;
        
        // Verifica qual das duas margens está mais próxima da margem digitada
        const diffBaixo = Math.abs(margemBaixo - margemDireta);
        const diffCima = Math.abs(margemCima - margemDireta);
        
        if (diffBaixo < diffCima) {
            sugestaoDiv.innerHTML = `💡 Sugestão para 2 casas: <strong>${margemBaixo.toFixed(2)}%</strong> (R$ ${vendaBaixo.toFixed(2)}) ou <strong>${margemCima.toFixed(2)}%</strong> (R$ ${vendaCima.toFixed(2)})`;
        } else {
            sugestaoDiv.innerHTML = `💡 Sugestão para 2 casas: <strong>${margemCima.toFixed(2)}%</strong> (R$ ${vendaCima.toFixed(2)}) ou <strong>${margemBaixo.toFixed(2)}%</strong> (R$ ${vendaBaixo.toFixed(2)})`;
        }
        
        sugestaoDiv.style.display = 'block';
    } else {
        if (sugestaoDiv) sugestaoDiv.style.display = 'none';
    }
}

// Limpa a margem direta quando o usuário digitar manualmente no valor de venda
document.getElementById('valorVenda').addEventListener('input', function() {
    // Se o usuário digitou no campo de venda, limpa a margem direta
    if (document.activeElement === this) {
        document.getElementById('margemDireta').value = '';
    }
});

// === ICMS 0% + ISENTO/DESONERADO + REPASSE BLOQUEADO ===
function atualizarICMS0ePMVG() {
  if (typeof calcularPMVG === 'function') calcularPMVG();
  atualizarBloqueioRepassePorIsento();
}

function atualizarBloqueioRepassePorIsento() {
  var isento = document.getElementById('chkIsento')?.checked;
  var r1075 = document.getElementById('repasse1075');
  var r1354 = document.getElementById('repasse1354');
  var rNaoSei = document.getElementById('repasseNaoSei');
  var rIsento = document.getElementById('repasseIsento');
  if (!(r1075 && r1354 && rNaoSei && rIsento)) return;

  if (isento) {
    // Marca automaticamente "SEM REPASSE - ISENTO" e bloqueia as opções
    rIsento.disabled = false;
    rIsento.checked = true;
    r1075.checked = false; r1354.checked = false; rNaoSei.checked = false;
    r1075.disabled = true;  r1354.disabled = true;  rNaoSei.disabled = true;
    rIsento.disabled = true;
  } else {
    // Reativa opções; mantém 10,75% como padrão se nada estiver escolhido
    r1075.disabled = false; r1354.disabled = false; rNaoSei.disabled = false;
    rIsento.checked = false;
    if (!r1075.checked && !r1354.checked && !rNaoSei.checked) {
      r1075.checked = true;
    }
  }
}

// Atualiza a mensagem do aviso apenas com base nos checkboxes
function atualizarAvisoPorChecks() {
  var des = document.getElementById('chkDesonerado')?.checked;
  var isento = document.getElementById('chkIsento')?.checked;
  if (typeof atualizarAvisoPF !== 'function') return;
  if (isento) {
    atualizarAvisoPF(true, 'ISENTO');
  } else if (des) {
    atualizarAvisoPF(true, 'DESONERADO');
  } else {
    atualizarAvisoPF(false);
  }
}
// ===== FUNÇÃO GLOBAL: zerarCalculosPorBase =====
function zerarCalculosPorBase() {
  // Zera inputs calculados
  ['valorICMS0','valorPMVG','valorPMVG0','custoProduto','valorPF']
    .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });

  // Zera textos de resultados
  const setTxt = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
  setTxt('valorCusto', 'R$ 0,0000');
  setTxt('margemBaseCusto', '0,00%');
  setTxt('margemPMVGCusto', '0,00%');
  setTxt('margemVendaCusto', '0,00%');
  setTxt('margemEstimadoCusto', '0,00%');
  setTxt('margemVendaEstimado', '0,00%');

  // Esconde áreas/itens
  ['campoPMVG','campoPMVG0','itemPMVGCusto','resultadoCusto','resultadoMargens','resumoArea']
    .forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });

  // Some com o aviso da calculadora 2
  if (typeof atualizarAvisoPorChecks === 'function') atualizarAvisoPorChecks();
}

/* === Eventos: MUTUAL EXCLUSIVE para DESONERADO x ISENTO === */
window.addEventListener('load', function () {
  var chkDes = document.getElementById('chkDesonerado');
  var chkIs  = document.getElementById('chkIsento');

  function aplicaExclusividade(source, target) {
    if (!source || !target) return;
    if (source.checked) {
      target.checked = false;   // desmarca o outro
    }
    atualizarICMS0ePMVG();      // recalcula e aplica bloqueios (repasse p/ ISENTO)
    calcularICMS0SemCAP();      // ← NOVA FUNÇÃO: calcula ICMS 0% mesmo sem CAP
    if (typeof atualizarAvisoPorChecks === 'function') atualizarAvisoPorChecks();
  }

  if (chkDes && chkIs) {
    chkDes.addEventListener('change', function(){ aplicaExclusividade(chkDes, chkIs); });
    chkIs .addEventListener('change', function(){ aplicaExclusividade(chkIs , chkDes); });
  }

  if (typeof atualizarAvisoPorChecks === 'function') atualizarAvisoPorChecks();
  // Estado inicial do REPASSE conforme ISENTO
  atualizarBloqueioRepassePorIsento();
});

</script>
<script>
// --- Gera o PDF do bloco de Resumo visível ---
function gerarPDFResumo() {
  const el = document.getElementById('resumoArea');
  if (!el) { alert('Resumo não encontrado.'); return; }
  // Gera diretamente do bloco visível
  const opcoes = {
    margin: [0.5, 0.5, 0.5, 0.5],
    filename: 'RELATÓRIO DE MARGENS.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, backgroundColor: '#ffffff', scrollX: 0, scrollY: 0 },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().set(opcoes).from(el).save();
}

// === NOVA FUNÇÃO: Calcula ICMS 0% quando ISENTO/DESONERADO, independente do CAP ===
function calcularICMS0SemCAP() {
  const basePF = parseFloat(document.getElementById('basePF')?.value || '');
  const des = document.getElementById('chkDesonerado')?.checked || false;
  const isento = document.getElementById('chkIsento')?.checked || false;
  const icms0El = document.getElementById('valorICMS0');
  const capAtivo = document.getElementById('capSim')?.checked || false;
  
  // Se não tem base PF válida, não faz nada
  if (isNaN(basePF) || basePF <= 0) {
    if (icms0El) icms0El.value = '';
    return;
  }
  
  // Se ISENTO ou DESONERADO está marcado, calcula ICMS 0%
  if (des || isento) {
    const valorICMS0 = +(basePF * 0.83).toFixed(4);
    if (icms0El) icms0El.value = valorICMS0.toFixed(4);
    
    // Se CAP NÃO está ativo, atualiza o campo "Valor do PF ou PMVG" 
    // da calculadora 2 com o ICMS 0%
    if (!capAtivo) {
      const valorPFEl = document.getElementById('valorPF');
      if (valorPFEl) valorPFEl.value = valorICMS0.toFixed(4);
      atualizarAvisoPF(true, isento ? 'ISENTO' : 'DESONERADO');
    }
  } else {
    // Se desmarcou ISENTO/DESONERADO, limpa ICMS 0%
    if (icms0El) icms0El.value = '';
    
    // Se CAP NÃO está ativo, volta o PF normal
    if (!capAtivo) {
      const valorPFEl = document.getElementById('valorPF');
      if (valorPFEl) valorPFEl.value = basePF.toFixed(4);
      atualizarAvisoPF(false);
    }
  }
}

// Esconde o botão PDF antigo, se existir, para evitar confusão
window.addEventListener('load', () => {
  const oldBtn = document.getElementById('btnGerarPDF');
  if (oldBtn) oldBtn.style.display = 'none';
  const resumoBtn = document.getElementById('btnGerarPDFResumo');
  if (resumoBtn) resumoBtn.addEventListener('click', gerarPDFResumo);
});
</script>
<button class="btn-flutuante" onclick="limparTudo()" 
        title="Limpar Tudo" 
        aria-label="Limpar todos os campos">
    Limpar Tudo 🗑️
</button>
<footer>
    <span>Desenvolvido por</span><strong>Vinicius R.</strong>
</footer>
</body>
</html>
